# المرحلة الأولى: إعداد الأساسيات - نظام إدارة الدروس والحضور بالرقم العشوائي

## 📋 نظرة عامة على المرحلة

هذه هي المرحلة الأولى من تطوير نظام إدارة الدروس والحضور بالرقم العشوائي. تركز هذه المرحلة على إعداد الأساسيات والبنية التحتية للمشروع.

**المدة المتوقعة:** 5-7 أيام عمل  
**الهدف:** إنشاء أساس قوي للمشروع مع جميع المكونات الأساسية

---

## 🎯 أهداف المرحلة الأولى

1. إعداد مشروع Laravel جديد مع جميع المتطلبات
2. إنشاء قاعدة البيانات والجداول الأساسية
3. تطوير النماذج (Models) والعلاقات
4. إعداد Filament Admin Panel
5. إنشاء البيانات التجريبية للاختبار
6. ضبط الصلاحيات الأساسية

---

## 📝 الخطوات التفصيلية

### الخطوة 1: تنزيل وإعداد Laravel

```bash
# 1.1 إنشاء مشروع Laravel جديد
composer create-project laravel/laravel BasmahAnwarAlOlmaaV1.0

# 1.2 الانتقال إلى مجلد المشروع
cd BasmahAnwarAlOlmaaV1.0

# 1.3 إعداد ملف البيئة
cp .env.example .env

# 1.4 توليد مفتاح التطبيق
php artisan key:generate
```

**ملاحظات:**
- تأكد من تثبيت Composer على النظام
- تأكد من إصدار PHP 8.1 أو أحدث
- تأكد من تفعيل extensions المطلوبة (mbstring, openssl, pdo, tokenizer, xml)

---

### الخطوة 2: إعداد قاعدة البيانات

```bash
# 2.1 إنشاء قاعدة بيانات MySQL جديدة
# اسم قاعدة البيانات: basmah_anwar_alolmaa
```

**تحديث ملف .env:**
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=basmah_anwar_alolmaa
DB_USERNAME=root
DB_PASSWORD=your_password
```

```bash
# 2.2 اختبار الاتصال بقاعدة البيانات
php artisan migrate
```

---

### الخطوة 3: تثبيت Filament Admin Panel

```bash
# 3.1 تثبيت Filament
composer require filament/filament:"^3.0"

# 3.2 تثبيت Filament Panel
php artisan filament:install --panels

# 3.3 إنشاء مستخدم مدير
php artisan make:filament-user
```

**معلومات المستخدم المدير:**
- الاسم: مدير النظام
- البريد الإلكتروني: admin@basmah.edu
- كلمة المرور: password123

---

### الخطوة 4: إنشاء المايجريشن للجداول الأساسية

```bash
# 4.1 إضافة حقل type لجدول المستخدمين
php artisan make:migration add_type_to_users_table

# 4.2 إنشاء جدول الدروس
php artisan make:migration create_lessons_table

# 4.3 إنشاء جدول ربط الطلاب بالدروس
php artisan make:migration create_lesson_student_table

# 4.4 إنشاء جدول الحضور
php artisan make:migration create_attendances_table

# 4.5 إنشاء جدول أكواد الحضور العشوائية
php artisan make:migration create_attendance_codes_table
```

**محتوى المايجريشن:**

**add_type_to_users_table:**
```php
public function up()
{
    Schema::table('users', function (Blueprint $table) {
        $table->enum('type', ['admin', 'teacher', 'student'])->default('student');
    });
}
```

**create_lessons_table:**
```php
public function up()
{
    Schema::create('lessons', function (Blueprint $table) {
        $table->id();
        $table->string('title');
        $table->text('description')->nullable();
        $table->foreignId('teacher_id')->constrained('users')->onDelete('cascade');
        $table->date('lesson_date');
        $table->time('start_time');
        $table->time('end_time');
        $table->string('location')->nullable();
        $table->boolean('is_active')->default(true);
        $table->timestamps();
    });
}
```

**create_lesson_student_table:**
```php
public function up()
{
    Schema::create('lesson_student', function (Blueprint $table) {
        $table->id();
        $table->foreignId('lesson_id')->constrained()->onDelete('cascade');
        $table->foreignId('student_id')->constrained('users')->onDelete('cascade');
        $table->timestamps();
        
        $table->unique(['lesson_id', 'student_id']);
    });
}
```

**create_attendances_table:**
```php
public function up()
{
    Schema::create('attendances', function (Blueprint $table) {
        $table->id();
        $table->foreignId('lesson_id')->constrained()->onDelete('cascade');
        $table->foreignId('student_id')->constrained('users')->onDelete('cascade');
        $table->enum('status', ['present', 'absent', 'late'])->default('present');
        $table->dateTime('attendance_date');
        $table->string('used_code', 6)->nullable();
        $table->timestamps();
        
        $table->unique(['lesson_id', 'student_id']);
    });
}
```

**create_attendance_codes_table:**
```php
public function up()
{
    Schema::create('attendance_codes', function (Blueprint $table) {
        $table->id();
        $table->foreignId('lesson_id')->constrained()->onDelete('cascade');
        $table->string('code', 6);
        $table->timestamp('expires_at');
        $table->boolean('is_active')->default(true);
        $table->timestamps();
    });
}
```

```bash
# 4.6 تشغيل المايجريشن
php artisan migrate
```

---

### الخطوة 5: إنشاء النماذج (Models)

```bash
# 5.1 إنشاء نموذج الدرس
php artisan make:model Lesson

# 5.2 إنشاء نموذج الحضور
php artisan make:model Attendance

# 5.3 إنشاء نموذج كود الحضور
php artisan make:model AttendanceCode
```

**محتوى النماذج:**

**app/Models/User.php (تحديث):**
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Laravel\Sanctum\HasApiTokens;

class User extends Authenticatable
{
    use HasApiTokens, HasFactory, Notifiable;

    protected $fillable = [
        'name',
        'email',
        'password',
        'type',
    ];

    protected $hidden = [
        'password',
        'remember_token',
    ];

    protected $casts = [
        'email_verified_at' => 'datetime',
        'password' => 'hashed',
    ];

    // العلاقات
    public function teacherLessons()
    {
        return $this->hasMany(Lesson::class, 'teacher_id');
    }

    public function studentLessons()
    {
        return $this->belongsToMany(Lesson::class, 'lesson_student', 'student_id', 'lesson_id');
    }

    public function attendances()
    {
        return $this->hasMany(Attendance::class, 'student_id');
    }

    // Helper methods
    public function isAdmin()
    {
        return $this->type === 'admin';
    }

    public function isTeacher()
    {
        return $this->type === 'teacher';
    }

    public function isStudent()
    {
        return $this->type === 'student';
    }
}
```

**app/Models/Lesson.php:**
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Lesson extends Model
{
    use HasFactory;

    protected $fillable = [
        'title',
        'description',
        'teacher_id',
        'lesson_date',
        'start_time',
        'end_time',
        'location',
        'is_active',
    ];

    protected $casts = [
        'lesson_date' => 'date',
        'start_time' => 'datetime:H:i',
        'end_time' => 'datetime:H:i',
        'is_active' => 'boolean',
    ];

    // العلاقات
    public function teacher()
    {
        return $this->belongsTo(User::class, 'teacher_id');
    }

    public function students()
    {
        return $this->belongsToMany(User::class, 'lesson_student', 'lesson_id', 'student_id');
    }

    public function attendances()
    {
        return $this->hasMany(Attendance::class);
    }

    public function attendanceCodes()
    {
        return $this->hasMany(AttendanceCode::class);
    }

    // Helper methods
    public function getCurrentAttendanceCode()
    {
        return $this->attendanceCodes()
            ->where('is_active', true)
            ->where('expires_at', '>', now())
            ->latest()
            ->first();
    }
}
```

**app/Models/Attendance.php:**
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Attendance extends Model
{
    use HasFactory;

    protected $fillable = [
        'lesson_id',
        'student_id',
        'status',
        'attendance_date',
        'used_code',
    ];

    protected $casts = [
        'attendance_date' => 'datetime',
    ];

    // العلاقات
    public function lesson()
    {
        return $this->belongsTo(Lesson::class);
    }

    public function student()
    {
        return $this->belongsTo(User::class, 'student_id');
    }
}
```

**app/Models/AttendanceCode.php:**
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class AttendanceCode extends Model
{
    use HasFactory;

    protected $fillable = [
        'lesson_id',
        'code',
        'expires_at',
        'is_active',
    ];

    protected $casts = [
        'expires_at' => 'datetime',
        'is_active' => 'boolean',
    ];

    // العلاقات
    public function lesson()
    {
        return $this->belongsTo(Lesson::class);
    }

    // Helper methods
    public function isExpired()
    {
        return $this->expires_at < now();
    }

    public function isValid()
    {
        return $this->is_active && !$this->isExpired();
    }
}
```

---

### الخطوة 6: إنشاء Filament Resources

```bash
# 6.1 إنشاء UserResource
php artisan make:filament-resource User --generate

# 6.2 إنشاء LessonResource
php artisan make:filament-resource Lesson --generate

# 6.3 إنشاء AttendanceResource
php artisan make:filament-resource Attendance --generate

# 6.4 إنشاء AttendanceCodeResource
php artisan make:filament-resource AttendanceCode --generate
```

---

### الخطوة 7: إنشاء RelationManagers

```bash
# 7.1 إنشاء StudentsRelationManager للدروس
php artisan make:filament-relation-manager LessonResource students StudentsRelationManager

# 7.2 إنشاء AttendancesRelationManager للدروس
php artisan make:filament-relation-manager LessonResource attendances AttendancesRelationManager

# 7.3 إنشاء LessonsRelationManager للمستخدمين
php artisan make:filament-relation-manager UserResource lessons LessonsRelationManager
```

---

### الخطوة 8: إنشاء Seeders للبيانات التجريبية

```bash
# 8.1 إنشاء UserSeeder
php artisan make:seeder UserSeeder

# 8.2 إنشاء LessonSeeder
php artisan make:seeder LessonSeeder

# 8.3 إنشاء AttendanceSeeder
php artisan make:seeder AttendanceSeeder
```

**محتوى Seeders:**

**database/seeders/UserSeeder.php:**
```php
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;

class UserSeeder extends Seeder
{
    public function run()
    {
        // إنشاء مدير النظام
        User::create([
            'name' => 'مدير النظام',
            'email' => 'admin@basmah.edu',
            'password' => Hash::make('password123'),
            'type' => 'admin',
        ]);

        // إنشاء أساتذة
        User::create([
            'name' => 'د. أحمد محمد',
            'email' => 'ahmed@basmah.edu',
            'password' => Hash::make('password123'),
            'type' => 'teacher',
        ]);

        User::create([
            'name' => 'د. فاطمة علي',
            'email' => 'fatima@basmah.edu',
            'password' => Hash::make('password123'),
            'type' => 'teacher',
        ]);

        // إنشاء طلاب
        for ($i = 1; $i <= 20; $i++) {
            User::create([
                'name' => "طالب رقم {$i}",
                'email' => "student{$i}@basmah.edu",
                'password' => Hash::make('password123'),
                'type' => 'student',
            ]);
        }
    }
}
```

```bash
# 8.4 تحديث DatabaseSeeder
# إضافة UserSeeder إلى database/seeders/DatabaseSeeder.php

# 8.5 تشغيل Seeders
php artisan db:seed
```

---

### الخطوة 9: إعداد الصلاحيات الأساسية

```bash
# 9.1 إنشاء Policies
php artisan make:policy LessonPolicy --model=Lesson
php artisan make:policy AttendancePolicy --model=Attendance
```

---

### الخطوة 10: اختبار النظام الأساسي

```bash
# 10.1 تشغيل الخادم المحلي
php artisan serve

# 10.2 زيارة لوحة التحكم
# http://localhost:8000/admin

# 10.3 تسجيل الدخول بحساب المدير
# البريد: admin@basmah.edu
# كلمة المرور: password123
```

---

## ✅ معايير إتمام المرحلة الأولى

- [ ] تم إنشاء مشروع Laravel بنجاح
- [ ] تم إعداد قاعدة البيانات وجميع الجداول
- [ ] تم إنشاء جميع النماذج مع العلاقات الصحيحة
- [ ] تم تثبيت وإعداد Filament Admin Panel
- [ ] تم إنشاء Filament Resources للجداول الأساسية
- [ ] تم إنشاء RelationManagers للعلاقات
- [ ] تم إنشاء البيانات التجريبية
- [ ] يمكن الوصول للوحة التحكم وعرض البيانات
- [ ] تم اختبار العمليات الأساسية (إنشاء، تعديل، حذف)

---

## 🔧 استكشاف الأخطاء الشائعة

### مشكلة: خطأ في الاتصال بقاعدة البيانات
**الحل:**
- تأكد من تشغيل خادم MySQL
- تحقق من صحة بيانات الاتصال في ملف .env
- تأكد من وجود قاعدة البيانات

### مشكلة: خطأ في Composer
**الحل:**
```bash
composer install
composer update
```

### مشكلة: خطأ في صلاحيات الملفات
**الحل:**
```bash
chmod -R 755 storage
chmod -R 755 bootstrap/cache
```

---

## 📚 الموارد المفيدة

- [Laravel Documentation](https://laravel.com/docs)
- [Filament Documentation](https://filamentphp.com/docs)
- [Laravel Eloquent Relationships](https://laravel.com/docs/eloquent-relationships)

---

## 🎯 الخطوة التالية

بعد إتمام هذه المرحلة بنجاح، ستكون جاهزاً للانتقال إلى **المرحلة الثانية: تطوير الميزات الأساسية** والتي تتضمن:

1. تطوير واجهات المستخدم المخصصة
2. تطبيق نظام الصلاحيات المتقدم
3. إنشاء لوحات التحكم المخصصة لكل نوع مستخدم
4. تطوير نظام الإشعارات

---

*تم إعداد هذا الملف في: 2025-01-12*  
*آخر تحديث: 2025-01-12*