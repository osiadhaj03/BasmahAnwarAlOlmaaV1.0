# المرحلة الثانية: تطوير النماذج والواجهات - نظام إدارة الدروس والحضور بالرقم العشوائي

## 📋 نظرة عامة على المرحلة

هذه هي المرحلة الثانية من تطوير نظام إدارة الدروس والحضور بالرقم العشوائي. تركز هذه المرحلة على إنشاء النماذج (Models) وتطوير واجهات Filament Admin Panel مع تطبيق منطق العمل الأساسي.

**المدة المتوقعة:** 7-10 أيام عمل  
**الهدف:** إنشاء نماذج البيانات الكاملة وواجهات إدارية فعالة مع تطبيق منطق العمل الأساسي

---

## 🎯 أهداف المرحلة الثانية

1. إنشاء جميع النماذج (Models) مع العلاقات الكاملة
2. تطوير Filament Resources للإدارة الكاملة
3. إنشاء RelationManagers للعلاقات المعقدة
4. تطبيق منطق توليد الأكواد العشوائية
5. إنشاء Seeders للبيانات التجريبية
6. تطوير واجهات مخصصة للمستخدمين
7. تطبيق نظام الصلاحيات الأساسي

---

## 📊 الوضع الحالي للمشروع

### ✅ ما تم إنجازه:
- ✅ إنشاء مشروع Laravel
- ✅ إعداد قاعدة البيانات
- ✅ إنشاء جميع ملفات المايجريشن (5 جداول)
- ✅ تشغيل المايجريشن بنجاح
- ✅ تحديث جدول المستخدمين بالحقول المطلوبة

### ❌ ما يحتاج إنجاز:
- ❌ إنشاء النماذج (Models) للجداول الجديدة
- ❌ تطوير Filament Resources
- ❌ إنشاء العلاقات بين النماذج
- ❌ تطبيق منطق العمل
- ❌ إنشاء البيانات التجريبية

---

## 📝 الخطوات التفصيلية

### الخطوة 1: إنشاء النماذج (Models)

```bash
# 1.1 إنشاء نموذج الدرس
php artisan make:model Lesson

# 1.2 إنشاء نموذج الحضور
php artisan make:model Attendance

# 1.3 إنشاء نموذج كود الحضور
php artisan make:model AttendanceCode
```

**محتوى النماذج:**

**app/Models/User.php (تحديث):**
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Filament\Models\Contracts\FilamentUser;
use Filament\Panel;

class User extends Authenticatable implements FilamentUser
{
    use HasFactory, Notifiable;

    protected $fillable = [
        'name',
        'email',
        'password',
        'type',
        'phone',
        'student_id',
        'employee_id',
        'bio',
        'department',
        'birth_date',
        'gender',
        'address',
        'is_active',
        'last_login_at',
    ];

    protected $hidden = [
        'password',
        'remember_token',
    ];

    protected $casts = [
        'email_verified_at' => 'datetime',
        'password' => 'hashed',
        'birth_date' => 'date',
        'last_login_at' => 'datetime',
        'is_active' => 'boolean',
    ];

    // Filament Access Control
    public function canAccessPanel(Panel $panel): bool
    {
        return $this->is_active && in_array($this->type, ['admin', 'teacher']);
    }

    // العلاقات
    public function teacherLessons()
    {
        return $this->hasMany(Lesson::class, 'teacher_id');
    }

    public function studentLessons()
    {
        return $this->belongsToMany(Lesson::class, 'lesson_student', 'student_id', 'lesson_id')
                    ->withPivot('enrolled_at', 'enrollment_status', 'notes')
                    ->withTimestamps();
    }

    public function attendances()
    {
        return $this->hasMany(Attendance::class, 'student_id');
    }

    public function createdAttendanceCodes()
    {
        return $this->hasMany(AttendanceCode::class, 'created_by');
    }

    public function deactivatedAttendanceCodes()
    {
        return $this->hasMany(AttendanceCode::class, 'deactivated_by');
    }

    public function markedAttendances()
    {
        return $this->hasMany(Attendance::class, 'marked_by');
    }

    // Helper methods
    public function isAdmin()
    {
        return $this->type === 'admin';
    }

    public function isTeacher()
    {
        return $this->type === 'teacher';
    }

    public function isStudent()
    {
        return $this->type === 'student';
    }

    public function getFullNameAttribute()
    {
        return $this->name;
    }

    // Scopes
    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }

    public function scopeByType($query, $type)
    {
        return $query->where('type', $type);
    }
}
```

**app/Models/Lesson.php:**
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Carbon\Carbon;

class Lesson extends Model
{
    use HasFactory;

    protected $fillable = [
        'title',
        'description',
        'teacher_id',
        'lesson_date',
        'start_time',
        'end_time',
        'location',
        'status',
        'max_students',
        'notes',
    ];

    protected $casts = [
        'lesson_date' => 'date',
        'start_time' => 'datetime:H:i',
        'end_time' => 'datetime:H:i',
        'max_students' => 'integer',
    ];

    // العلاقات
    public function teacher()
    {
        return $this->belongsTo(User::class, 'teacher_id');
    }

    public function students()
    {
        return $this->belongsToMany(User::class, 'lesson_student', 'lesson_id', 'student_id')
                    ->withPivot('enrolled_at', 'enrollment_status', 'notes')
                    ->withTimestamps();
    }

    public function attendances()
    {
        return $this->hasMany(Attendance::class);
    }

    public function attendanceCodes()
    {
        return $this->hasMany(AttendanceCode::class);
    }

    public function activeAttendanceCodes()
    {
        return $this->hasMany(AttendanceCode::class)->where('is_active', true);
    }

    // Helper methods
    public function getFullDateTimeAttribute()
    {
        return $this->lesson_date->format('Y-m-d') . ' ' . $this->start_time . ' - ' . $this->end_time;
    }

    public function getDurationAttribute()
    {
        $start = Carbon::parse($this->start_time);
        $end = Carbon::parse($this->end_time);
        return $start->diffInMinutes($end);
    }

    public function getEnrolledStudentsCountAttribute()
    {
        return $this->students()->wherePivot('enrollment_status', 'enrolled')->count();
    }

    public function getAttendanceRateAttribute()
    {
        $totalStudents = $this->enrolledStudentsCount;
        if ($totalStudents === 0) return 0;
        
        $presentStudents = $this->attendances()->where('status', 'present')->count();
        return round(($presentStudents / $totalStudents) * 100, 2);
    }

    public function canEnrollMoreStudents()
    {
        return $this->max_students === null || $this->enrolledStudentsCount < $this->max_students;
    }

    // Scopes
    public function scopeActive($query)
    {
        return $query->where('status', 'active');
    }

    public function scopeByTeacher($query, $teacherId)
    {
        return $query->where('teacher_id', $teacherId);
    }

    public function scopeUpcoming($query)
    {
        return $query->where('lesson_date', '>=', now()->toDateString());
    }

    public function scopeToday($query)
    {
        return $query->where('lesson_date', now()->toDateString());
    }
}
```

**app/Models/Attendance.php:**
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Attendance extends Model
{
    use HasFactory;

    protected $fillable = [
        'lesson_id',
        'student_id',
        'status',
        'attendance_date',
        'used_code',
        'attendance_method',
        'notes',
        'marked_at',
        'marked_by',
    ];

    protected $casts = [
        'attendance_date' => 'datetime',
        'marked_at' => 'datetime',
    ];

    // العلاقات
    public function lesson()
    {
        return $this->belongsTo(Lesson::class);
    }

    public function student()
    {
        return $this->belongsTo(User::class, 'student_id');
    }

    public function markedBy()
    {
        return $this->belongsTo(User::class, 'marked_by');
    }

    // Helper methods
    public function getStatusLabelAttribute()
    {
        return match($this->status) {
            'present' => 'حاضر',
            'absent' => 'غائب',
            'late' => 'متأخر',
            'excused' => 'معذور',
            default => 'غير محدد'
        };
    }

    public function getMethodLabelAttribute()
    {
        return match($this->attendance_method) {
            'code' => 'كود عشوائي',
            'manual' => 'يدوي',
            'qr' => 'QR Code',
            default => 'غير محدد'
        };
    }

    // Scopes
    public function scopePresent($query)
    {
        return $query->where('status', 'present');
    }

    public function scopeAbsent($query)
    {
        return $query->where('status', 'absent');
    }

    public function scopeByLesson($query, $lessonId)
    {
        return $query->where('lesson_id', $lessonId);
    }

    public function scopeByStudent($query, $studentId)
    {
        return $query->where('student_id', $studentId);
    }
}
```

**app/Models/AttendanceCode.php:**
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;

class AttendanceCode extends Model
{
    use HasFactory;

    protected $fillable = [
        'lesson_id',
        'code',
        'expires_at',
        'is_active',
        'usage_count',
        'max_usage',
        'created_by',
        'deactivated_at',
        'deactivated_by',
        'notes',
    ];

    protected $casts = [
        'expires_at' => 'datetime',
        'is_active' => 'boolean',
        'usage_count' => 'integer',
        'max_usage' => 'integer',
        'deactivated_at' => 'datetime',
    ];

    // العلاقات
    public function lesson()
    {
        return $this->belongsTo(Lesson::class);
    }

    public function createdBy()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    public function deactivatedBy()
    {
        return $this->belongsTo(User::class, 'deactivated_by');
    }

    // Helper methods
    public static function generateUniqueCode($length = 6)
    {
        do {
            $code = strtoupper(Str::random($length));
        } while (self::where('code', $code)->where('is_active', true)->exists());

        return $code;
    }

    public function isExpired()
    {
        return $this->expires_at < now();
    }

    public function isUsageLimitReached()
    {
        return $this->max_usage !== null && $this->usage_count >= $this->max_usage;
    }

    public function canBeUsed()
    {
        return $this->is_active && !$this->isExpired() && !$this->isUsageLimitReached();
    }

    public function incrementUsage()
    {
        $this->increment('usage_count');
        
        if ($this->isUsageLimitReached()) {
            $this->update(['is_active' => false]);
        }
    }

    public function deactivate($userId = null, $reason = null)
    {
        $this->update([
            'is_active' => false,
            'deactivated_at' => now(),
            'deactivated_by' => $userId,
            'notes' => $reason ? $this->notes . "\nتم إلغاء التفعيل: " . $reason : $this->notes,
        ]);
    }

    // Scopes
    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }

    public function scopeExpired($query)
    {
        return $query->where('expires_at', '<', now());
    }

    public function scopeValid($query)
    {
        return $query->where('is_active', true)
                    ->where('expires_at', '>', now());
    }

    public function scopeByLesson($query, $lessonId)
    {
        return $query->where('lesson_id', $lessonId);
    }
}
```

---

### الخطوة 2: تثبيت وإعداد Filament

```bash
# 2.1 تثبيت Filament (إذا لم يكن مثبتاً)
composer require filament/filament:"^3.0"

# 2.2 تثبيت Filament Panel
php artisan filament:install --panels

# 2.3 إنشاء مستخدم مدير
php artisan make:filament-user
```

---

### الخطوة 3: إنشاء Filament Resources

```bash
# 3.1 إنشاء Resource للمستخدمين
php artisan make:filament-resource User --generate

# 3.2 إنشاء Resource للدروس
php artisan make:filament-resource Lesson --generate

# 3.3 إنشاء Resource للحضور
php artisan make:filament-resource Attendance --generate

# 3.4 إنشاء Resource لأكواد الحضور
php artisan make:filament-resource AttendanceCode --generate
```

---

### الخطوة 4: إنشاء RelationManagers

```bash
# 4.1 إنشاء RelationManager للطلاب في الدروس
php artisan make:filament-relation-manager LessonResource students

# 4.2 إنشاء RelationManager للحضور في الدروس
php artisan make:filament-relation-manager LessonResource attendances

# 4.3 إنشاء RelationManager لأكواد الحضور في الدروس
php artisan make:filament-relation-manager LessonResource attendanceCodes

# 4.4 إنشاء RelationManager للدروس في المستخدمين
php artisan make:filament-relation-manager UserResource teacherLessons
```

---

### الخطوة 5: إنشاء Seeders للبيانات التجريبية

```bash
# 5.1 إنشاء Seeder للمستخدمين
php artisan make:seeder UserSeeder

# 5.2 إنشاء Seeder للدروس
php artisan make:seeder LessonSeeder

# 5.3 إنشاء Seeder للحضور
php artisan make:seeder AttendanceSeeder

# 5.4 إنشاء Seeder لأكواد الحضور
php artisan make:seeder AttendanceCodeSeeder
```

---

### الخطوة 6: إنشاء Factories للاختبار

```bash
# 6.1 إنشاء Factory للدروس
php artisan make:factory LessonFactory

# 6.2 إنشاء Factory للحضور
php artisan make:factory AttendanceFactory

# 6.3 إنشاء Factory لأكواد الحضور
php artisan make:factory AttendanceCodeFactory
```

---

### الخطوة 7: تطوير منطق العمل الأساسي

```bash
# 7.1 إنشاء Service للأكواد العشوائية
php artisan make:class Services/AttendanceCodeService

# 7.2 إنشاء Service لإدارة الحضور
php artisan make:class Services/AttendanceService

# 7.3 إنشاء Observer للأحداث
php artisan make:observer AttendanceCodeObserver --model=AttendanceCode
```

---

## 🔧 المتطلبات الفنية

### متطلبات الخادم:
- **PHP:** 8.1 أو أحدث
- **Laravel:** 10.x
- **MySQL:** 8.0 أو أحدث
- **Composer:** 2.x
- **Node.js:** 18.x أو أحدث (للواجهة الأمامية)

### المكتبات المطلوبة:
- **Filament:** ^3.0 (لوحة الإدارة)
- **Laravel Sanctum:** للمصادقة API
- **Carbon:** للتعامل مع التواريخ
- **Intervention Image:** لمعالجة الصور (اختياري)

### إعدادات قاعدة البيانات:
- **Engine:** InnoDB
- **Charset:** utf8mb4
- **Collation:** utf8mb4_unicode_ci

---

## 📅 الجدول الزمني المقترح

### الأسبوع الأول (5 أيام):
- **اليوم 1-2:** إنشاء النماذج والعلاقات
- **اليوم 3-4:** تطوير Filament Resources الأساسية
- **اليوم 5:** إنشاء RelationManagers

### الأسبوع الثاني (5 أيام):
- **اليوم 6-7:** تطوير منطق الأكواد العشوائية
- **اليوم 8-9:** إنشاء Seeders والبيانات التجريبية
- **اليوم 10:** اختبار شامل وتصحيح الأخطاء

---

## ⚠️ اعتبارات خاصة

### الأمان:
1. **تشفير كلمات المرور:** استخدام Hash::make()
2. **حماية CSRF:** تفعيل حماية Laravel CSRF
3. **تنظيف المدخلات:** استخدام Validation Rules
4. **صلاحيات الوصول:** تطبيق Authorization Policies

### الأداء:
1. **الفهرسة:** إضافة فهارس مناسبة لقاعدة البيانات
2. **Eager Loading:** استخدام with() لتجنب N+1 Problem
3. **التخزين المؤقت:** استخدام Cache للبيانات المتكررة
4. **تحسين الاستعلامات:** استخدام Query Builder بكفاءة

### قابلية التوسع:
1. **هيكل مرن:** تصميم يدعم إضافة ميزات جديدة
2. **فصل المنطق:** استخدام Services و Repositories
3. **إدارة الأحداث:** استخدام Events و Listeners
4. **API Ready:** تحضير للواجهات البرمجية المستقبلية

### تجربة المستخدم:
1. **واجهات بديهية:** تصميم سهل الاستخدام
2. **رسائل واضحة:** إشعارات مفهومة للمستخدم
3. **استجابة سريعة:** تحميل سريع للصفحات
4. **دعم الأجهزة المحمولة:** تصميم متجاوب

---

## ✅ معايير إتمام المرحلة الثانية

- [ ] تم إنشاء جميع النماذج مع العلاقات الصحيحة
- [ ] تم تطوير Filament Resources الكاملة
- [ ] تم إنشاء RelationManagers للعلاقات المعقدة
- [ ] تم تطبيق منطق توليد الأكواد العشوائية
- [ ] تم إنشاء Seeders وتشغيلها بنجاح
- [ ] تم اختبار جميع العمليات الأساسية
- [ ] تم تطبيق نظام الصلاحيات الأساسي
- [ ] تم توثيق الكود والواجهات

---

## 🔧 استكشاف الأخطاء المتوقعة

### مشكلة: خطأ في العلاقات
**الحل:**
- تحقق من أسماء الحقول في المايجريشن
- تأكد من صحة Foreign Keys
- راجع أسماء الجداول والنماذج

### مشكلة: خطأ في Filament Resources
**الحل:**
```bash
php artisan filament:upgrade
php artisan view:clear
php artisan config:clear
```

### مشكلة: خطأ في الصلاحيات
**الحل:**
- تحقق من تطبيق FilamentUser interface
- راجع دالة canAccessPanel()
- تأكد من صحة نوع المستخدم

---

## 📚 الموارد المفيدة

- [Laravel Eloquent Relationships](https://laravel.com/docs/eloquent-relationships)
- [Filament Resources Documentation](https://filamentphp.com/docs/panels/resources)
- [Laravel Seeders and Factories](https://laravel.com/docs/seeding)
- [Laravel Authorization](https://laravel.com/docs/authorization)

---

## 🎯 الخطوة التالية

بعد إتمام هذه المرحلة بنجاح، ستكون جاهزاً للانتقال إلى **المرحلة الثالثة: تطوير الميزات المتقدمة** والتي تتضمن:

1. تطوير واجهة الطلاب لإدخال الأكواد
2. إنشاء نظام الإشعارات المتقدم
3. تطوير التقارير والإحصائيات
4. تطبيق نظام الصلاحيات المتقدم
5. تحسين تجربة المستخدم

---

*تم إعداد هذا الملف في: 2025-01-14*  
*آخر تحديث: 2025-01-14*