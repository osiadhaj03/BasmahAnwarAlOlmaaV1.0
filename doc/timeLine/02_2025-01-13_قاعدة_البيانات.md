# 🗄️ الملف الزمني رقم 2 - قاعدة البيانات
**التاريخ:** 13 يناير 2025  
**الموضوع:** هيكل قاعدة البيانات والتطبيق  
**الحالة:** مكتمل ✅

---

## 📊 نظرة عامة على قاعدة البيانات

### نوع قاعدة البيانات
**MySQL** - قاعدة بيانات علائقية متقدمة مع دعم كامل لـ Laravel Eloquent ORM

### عدد الجداول الأساسية
**7 جداول** - 3 جداول Laravel الافتراضية + 4 جداول مخصصة للمشروع

---

## 🏗️ الجداول المُنشأة والمُطبقة

### 1. جداول Laravel الافتراضية

#### 📋 جدول `users`
```sql
-- Migration: 0001_01_01_000000_create_users_table.php
CREATE TABLE users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    email_verified_at TIMESTAMP NULL,
    password VARCHAR(255) NOT NULL,
    remember_token VARCHAR(100) NULL,
    
    -- الحقول المضافة للمشروع
    type ENUM('admin', 'teacher', 'student') NOT NULL DEFAULT 'student',
    phone VARCHAR(20) NULL,
    student_id VARCHAR(50) UNIQUE NULL,
    employee_id VARCHAR(50) UNIQUE NULL,
    bio TEXT NULL,
    department VARCHAR(100) NULL,
    birth_date DATE NULL,
    gender ENUM('male', 'female') NULL,
    address TEXT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP NULL,
    
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL
);
```

#### 🗂️ جدول `cache`
```sql
-- Migration: 0001_01_01_000001_create_cache_table.php
CREATE TABLE cache (
    key VARCHAR(255) PRIMARY KEY,
    value MEDIUMTEXT NOT NULL,
    expiration INT NOT NULL
);

CREATE TABLE cache_locks (
    key VARCHAR(255) PRIMARY KEY,
    owner VARCHAR(255) NOT NULL,
    expiration INT NOT NULL
);
```

#### ⚙️ جدول `jobs`
```sql
-- Migration: 0001_01_01_000002_create_jobs_table.php
CREATE TABLE jobs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    queue VARCHAR(255) NOT NULL,
    payload LONGTEXT NOT NULL,
    attempts TINYINT UNSIGNED NOT NULL,
    reserved_at INT UNSIGNED NULL,
    available_at INT UNSIGNED NOT NULL,
    created_at INT UNSIGNED NOT NULL
);

CREATE TABLE job_batches (
    id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    total_jobs INT NOT NULL,
    pending_jobs INT NOT NULL,
    failed_jobs INT NOT NULL,
    failed_job_ids LONGTEXT NOT NULL,
    options MEDIUMTEXT NULL,
    cancelled_at INT NULL,
    created_at INT NOT NULL,
    finished_at INT NULL
);

CREATE TABLE failed_jobs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    uuid VARCHAR(255) UNIQUE NOT NULL,
    connection TEXT NOT NULL,
    queue TEXT NOT NULL,
    payload LONGTEXT NOT NULL,
    exception LONGTEXT NOT NULL,
    failed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. جداول المشروع المخصصة

#### 📚 جدول `lessons`
```sql
-- Migration: 2025_10_14_085831_create_lessons_table.php
CREATE TABLE lessons (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT NULL,
    teacher_id BIGINT UNSIGNED NOT NULL,
    lesson_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    location VARCHAR(255) NULL,
    max_students INT DEFAULT 30,
    is_active BOOLEAN DEFAULT TRUE,
    notes TEXT NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    FOREIGN KEY (teacher_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_lesson_date (lesson_date),
    INDEX idx_teacher_id (teacher_id),
    INDEX idx_is_active (is_active)
);
```

#### 🔗 جدول `lesson_student`
```sql
-- Migration: 2025_10_14_085922_create_lesson_student_table.php
CREATE TABLE lesson_student (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    lesson_id BIGINT UNSIGNED NOT NULL,
    student_id BIGINT UNSIGNED NOT NULL,
    enrolled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    notes TEXT NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    FOREIGN KEY (lesson_id) REFERENCES lessons(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_lesson_student (lesson_id, student_id),
    INDEX idx_lesson_id (lesson_id),
    INDEX idx_student_id (student_id)
);
```

#### ✅ جدول `attendances`
```sql
-- Migration: 2025_10_14_090010_create_attendances_table.php
CREATE TABLE attendances (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    lesson_id BIGINT UNSIGNED NOT NULL,
    student_id BIGINT UNSIGNED NOT NULL,
    status ENUM('present', 'absent', 'late', 'excused') NOT NULL DEFAULT 'absent',
    attendance_time TIMESTAMP NULL,
    method ENUM('manual', 'code', 'auto') NOT NULL DEFAULT 'manual',
    marked_by BIGINT UNSIGNED NULL,
    notes TEXT NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    FOREIGN KEY (lesson_id) REFERENCES lessons(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (marked_by) REFERENCES users(id) ON DELETE SET NULL,
    UNIQUE KEY unique_lesson_student_attendance (lesson_id, student_id),
    INDEX idx_lesson_id (lesson_id),
    INDEX idx_student_id (student_id),
    INDEX idx_status (status),
    INDEX idx_attendance_time (attendance_time)
);
```

#### 🔢 جدول `attendance_codes`
```sql
-- Migration: 2025_10_14_090058_create_attendance_codes_table.php
CREATE TABLE attendance_codes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    lesson_id BIGINT UNSIGNED NOT NULL,
    code VARCHAR(10) UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    max_usage INT DEFAULT 1,
    current_usage INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT UNSIGNED NOT NULL,
    deactivated_by BIGINT UNSIGNED NULL,
    deactivated_at TIMESTAMP NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    
    FOREIGN KEY (lesson_id) REFERENCES lessons(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (deactivated_by) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_lesson_id (lesson_id),
    INDEX idx_code (code),
    INDEX idx_expires_at (expires_at),
    INDEX idx_is_active (is_active)
);
```

---

## 🔗 العلاقات بين الجداول

### العلاقات الأساسية

#### 1. علاقات جدول `users`
```
users (1) -----> (∞) lessons [teacher_id]
users (∞) <----> (∞) lessons [lesson_student table]
users (1) -----> (∞) attendances [student_id]
users (1) -----> (∞) attendances [marked_by]
users (1) -----> (∞) attendance_codes [created_by]
users (1) -----> (∞) attendance_codes [deactivated_by]
```

#### 2. علاقات جدول `lessons`
```
lessons (1) -----> (∞) lesson_student [lesson_id]
lessons (1) -----> (∞) attendances [lesson_id]
lessons (1) -----> (∞) attendance_codes [lesson_id]
```

#### 3. علاقات جدول `lesson_student`
```
lesson_student (∞) -----> (1) lessons [lesson_id]
lesson_student (∞) -----> (1) users [student_id]
```

#### 4. علاقات جدول `attendances`
```
attendances (∞) -----> (1) lessons [lesson_id]
attendances (∞) -----> (1) users [student_id]
attendances (∞) -----> (1) users [marked_by]
```

#### 5. علاقات جدول `attendance_codes`
```
attendance_codes (∞) -----> (1) lessons [lesson_id]
attendance_codes (∞) -----> (1) users [created_by]
attendance_codes (∞) -----> (1) users [deactivated_by]
```

---

## 📈 إحصائيات قاعدة البيانات

### حالة الجداول
| الجدول | الحالة | عدد الحقول | المفاتيح الخارجية | الفهارس |
|--------|--------|------------|------------------|---------|
| users | ✅ مُطبق | 17 | 0 | 3 |
| lessons | ✅ مُطبق | 12 | 1 | 4 |
| lesson_student | ✅ مُطبق | 8 | 2 | 3 |
| attendances | ✅ مُطبق | 10 | 3 | 5 |
| attendance_codes | ✅ مُطبق | 12 | 3 | 4 |
| cache | ✅ مُطبق | 3 | 0 | 1 |
| jobs | ✅ مُطبق | 7 | 0 | 2 |

### إجمالي الإحصائيات
- **إجمالي الجداول:** 7
- **إجمالي الحقول:** 69
- **إجمالي المفاتيح الخارجية:** 9
- **إجمالي الفهارس:** 22

---

## 🛠️ أوامر Laravel المُستخدمة

### إنشاء الجداول (Migrations)
```bash
# الجداول الافتراضية (تم إنشاؤها تلقائياً)
php artisan install:api

# جداول المشروع المخصصة
php artisan make:migration create_lessons_table
php artisan make:migration create_lesson_student_table  
php artisan make:migration create_attendances_table
php artisan make:migration create_attendance_codes_table
```

### تطبيق الجداول
```bash
# تطبيق جميع الجداول
php artisan migrate

# التحقق من حالة الجداول
php artisan migrate:status
```

### نتيجة `migrate:status`
```
Migration name ......................................................... Batch / Status
0001_01_01_000000_create_users_table ................................... [1] Ran
0001_01_01_000001_create_cache_table ................................... [1] Ran
0001_01_01_000002_create_jobs_table .................................... [1] Ran
2025_10_14_085831_create_lessons_table ................................. [1] Ran
2025_10_14_085922_create_lesson_student_table .......................... [1] Ran
2025_10_14_090010_create_attendances_table ............................. [1] Ran
2025_10_14_090058_create_attendance_codes_table ........................ [1] Ran
```

---

## 🔍 تحليل الأداء والتحسين

### الفهارس المُطبقة

#### جدول `users`
- **PRIMARY:** id
- **UNIQUE:** email, student_id, employee_id
- **INDEX:** type, is_active

#### جدول `lessons`
- **PRIMARY:** id
- **FOREIGN KEY:** teacher_id → users(id)
- **INDEX:** lesson_date, teacher_id, is_active

#### جدول `lesson_student`
- **PRIMARY:** id
- **FOREIGN KEY:** lesson_id → lessons(id), student_id → users(id)
- **UNIQUE:** (lesson_id, student_id)
- **INDEX:** lesson_id, student_id

#### جدول `attendances`
- **PRIMARY:** id
- **FOREIGN KEY:** lesson_id → lessons(id), student_id → users(id), marked_by → users(id)
- **UNIQUE:** (lesson_id, student_id)
- **INDEX:** lesson_id, student_id, status, attendance_time

#### جدول `attendance_codes`
- **PRIMARY:** id
- **FOREIGN KEY:** lesson_id → lessons(id), created_by → users(id), deactivated_by → users(id)
- **UNIQUE:** code
- **INDEX:** lesson_id, code, expires_at, is_active

### تحسينات الأداء المُطبقة
1. **فهرسة الحقول المُستعلم عنها بكثرة**
2. **قيود الفرادة لمنع التكرار**
3. **المفاتيح الخارجية للحفاظ على سلامة البيانات**
4. **أنواع البيانات المُحسنة (ENUM, BOOLEAN)**

---

## 🔒 اعتبارات الأمان المُطبقة

### حماية البيانات
- **تشفير كلمات المرور** باستخدام bcrypt
- **قيود المفاتيح الخارجية** لمنع البيانات المعلقة
- **فهرسة الحقول الحساسة** لتحسين الأداء

### سلامة البيانات
- **قيود الفرادة** للحقول المهمة (email, student_id, code)
- **قيود NOT NULL** للحقول الإجبارية
- **قيم افتراضية** للحقول الاختيارية

### إدارة الحذف
- **CASCADE DELETE** للبيانات التابعة
- **SET NULL** للمراجع الاختيارية
- **حماية من الحذف العرضي**

---

## 📊 سيناريوهات الاستخدام

### 1. إنشاء درس جديد
```sql
-- إدراج درس جديد
INSERT INTO lessons (title, description, teacher_id, lesson_date, start_time, end_time, location, max_students)
VALUES ('مقدمة في البرمجة', 'درس تعريفي بأساسيات البرمجة', 1, '2025-01-15', '09:00:00', '11:00:00', 'قاعة A1', 25);

-- ربط الطلاب بالدرس
INSERT INTO lesson_student (lesson_id, student_id) VALUES (1, 2), (1, 3), (1, 4);
```

### 2. توليد كود حضور
```sql
-- إنشاء كود حضور جديد
INSERT INTO attendance_codes (lesson_id, code, expires_at, max_usage, created_by)
VALUES (1, 'ABC123', '2025-01-15 09:30:00', 25, 1);
```

### 3. تسجيل الحضور
```sql
-- تسجيل حضور طالب
INSERT INTO attendances (lesson_id, student_id, status, attendance_time, method, marked_by)
VALUES (1, 2, 'present', NOW(), 'code', 1);

-- تحديث استخدام الكود
UPDATE attendance_codes SET current_usage = current_usage + 1 WHERE id = 1;
```

---

## 🚀 الخطوات التالية

### المرحلة القادمة
1. **إنشاء النماذج (Models)** مع العلاقات الكاملة
2. **تطوير Filament Resources** للإدارة
3. **إنشاء Seeders** لبيانات تجريبية
4. **تطوير منطق الأعمال** الأساسي

### التحسينات المستقبلية
1. **إضافة فهارس مركبة** للاستعلامات المعقدة
2. **تطبيق Soft Deletes** للبيانات المهمة
3. **إضافة جداول التدقيق** لتتبع التغييرات
4. **تحسين أداء الاستعلامات** الكبيرة

---

## 📝 ملاحظات تقنية

### نقاط القوة
✅ **هيكل منطقي ومرن** للبيانات  
✅ **علاقات محكمة** بين الجداول  
✅ **فهرسة محسنة** للأداء  
✅ **قيود أمان** شاملة  
✅ **قابلية التوسع** المستقبلية  

### التحديات المحلولة
✅ **منع تكرار التسجيل** في نفس الدرس  
✅ **ضمان فرادة أكواد الحضور**  
✅ **إدارة انتهاء صلاحية الأكواد**  
✅ **تتبع مصدر تسجيل الحضور**  
✅ **مرونة في إدارة المستخدمين**  

---

**📅 تاريخ الإنشاء:** 13 يناير 2025  
**👤 المطور:** Osaid Salah  
**🗄️ نوع قاعدة البيانات:** MySQL  
**📊 إجمالي الجداول:** 7 جداول  

---

*هذا الملف جزء من سلسلة الملفات الزمنية لتوثيق تقدم مشروع BasmahAnwarAlOlmaaV1.0*